# 内网穿透

不写引子了，懒。

主要了解这块的原因是2024年03月，深圳电信强制把我的公网IP给改为了内网IP，同时不支持IPv6。这边打电话咨询后告知，当前不提供公网IPv4，如确实有需求，额外加100元/月可购买一个公网IPv4。

## 简介

内网穿透有多个别称，P2P、P2P打洞、内网直连。

这些最原始的需求其实就是，我当前有两台内网电脑（不在同一局域网内），同时我希望他们能互相访问。

在这种时候，我们有几种解决方法。

1. 转发模式（通过拥有公网IP的服务器转发两个客户端之间的通信）
   - 该方式是需要你有一个公网服务器IP
   - 同时，你传输的宽带速率通常会被你服务器的速率所限制（服务器带宽极贵，特别是中国运营商），同时在某些极端情况下，延迟也会略高。
2. P2P内网穿透模式（两台机子通过某种方式成功实现互联）
   - 该方式也是需要你有一个公网服务器IP
   - 同时，该方式要求了一定的NAT类型。
   - 其相比于转发模式的优点在于，如果打洞成功，在带宽上仅受限与自己的上传下载网速。

### NAT介绍

> https://zhuanlan.zhihu.com/p/572587706



### 内网穿透原理

> https://zhuanlan.zhihu.com/p/572587706

其实在上文的连接中也有提到，但对于我个人还没有理解透彻，看他的结论感觉还是缺点理解。所以此处基于自己的理解尝试写简单理论（当前理解未经实验，仅是曾探讨过的可能性）

背景：

- 我们是使用P2P
- 有以下关键词
  - c1（client1）
  - c2（client2）
  - s(server），定义为拥有公网IP的服务器。
  - ft（五元组、five-tuple）
  - socket（链接）

流程

1. c1 与 s 建立连接，此时我们可以得到以下信息
   - c1:ft，s:ft（此命名为 sft1）
2. c2 与 s 建立连接，此时我们也可以得到如下信息
   - c2:ft，s:ft（此命名为 sft2）
3. 此时我们使用s，往c1发送 sft2，往c2发送 sft1
4. 此时双端都得到了五元组信息。
5. c1根据 sft2 捏造出一个socket，往c2发送数据包
   - 其中src为s的ip，src.port为s的port，dst为c2的ip，dst.port为c2的port
   - 直接使用该socket进行发包（此实现理论基于上层Nat仅做转发，不对ft的src进行检查。能够绕过检测
6. c2同理，根据sft1捏造出socket，往c1发送数据包。
7. 如上述连通，则互联成功。



