# 负载均衡



负载均衡有多种实现方式

1. 中心化负载均衡
   - 服务统一请求某一个负载均衡中心，获取每个服务的信息
2. 去中心化负载均衡
   - 去中心化负载均衡就是在每个服务内部实现

### 简单指标

服务端负载有以下几个取值

- QPS
- CPU利用率
- TCP连接数
- 服务器性能权重。

以上几个都是常见的服务端负载指标。

在这里我们先采用 CPU 利用率。由于每个机器性能不同，QPS与TCP连接数并不一定能代表服务器完整的性能，服务器性能权重是需要运维手动调优，对于运维水平以及要求过高。



### 中心化方案

设定中心服务器用于分发，派发任务，统计各个服务的压力。

所有客户端去访问该中心服务器，获取本次请求该去访问哪些服务



### 去中心化方案

客户端去中心化方案有多种方式可以实现。

- 轮询
- 随机
- 加权轮询
- 服务端性能权重



利用服务端的负载以及各种指标决定。





#### 客户端算法：

可根据 服务延迟+服务端负载 进行对比，划分区域。在该区域内部进行。

定时对其进行评估更新。

将服务端分成多档

- 一档 -- 服务延迟与服务端负载极优
- 二档 -- 上一次得分不够优异
- 三档 -- 尽量不要访问
- 四档 -- 再访问就挂了



根据不同的档位去优先请求某一个服务。

**同时，报错也可采取当前操作。发现某个服务一直报错后，对其进行降级，减少对其访问次数**



#### 服务端算法

根据上面客户端算法，我们可以得出，最重要的是延迟与服务端负载指标，我们当前服务端负载指标采用CPU进行记录。[CPU计算方式](./cpu 利用率计算方式.md)

同时，为了防止CPU出现毛刺。（忽高忽低），我们可以减少间隔时间，同时增加给每个时间节点进行加权。

推荐的算法如下：`上次CPU利用率 * 0.3 + 当前CPU利用率 * 0.7` 得出当前CPU利用率，使得尽量平滑。





### 令牌桶

令牌桶用于限速限流。

令牌桶做成range环（减少垃圾回收），当需要调用grpc服务时，从令牌桶中获取值。

一个生产者一直监听令牌桶。当令牌桶出现空缺后，根据一定算法往里面填值。

**建议将其直接设置在所有出口。再不需要限速时想办法规避。再需要限速时想办法开启。**

- 